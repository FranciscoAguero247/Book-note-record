<%- include('partials/header.ejs'); -%>
<section class="notebook">
    <nav>
        <div class="nav__container">
            <h4 class="note__title">Book Note Collection</h4>


            <div class="drop__down__sort__menu">
                <form action="/sort" method="post">
                    <label for="selection">Sort by:</label>
                        <select name="drop_sort_down_menu">
                            <option value="highest-rating">Highest Rating</option>
                            <option value="lowest-rating">Lowest Rating</option>
                            <option value="recent">Most recent</option>
                            <option value="oldest">Oldest</option>
                            <option value="title-sort">Title(A-Z)</option>
                        </select>
                        <button type="submit" class="click">Submit</button>
                </form>
            </div>

            <div class="search-container">
                <form action="/search" method="get">
                    <input type="text" name="q" placeholder="Search by title or author..." required>
                    <button type="submit" class="search-btn">
                        <i class="fa fa-search search-icon" aria-hidden="true"></i>
                    </button>
                    <a href="/" class="clear-btn">Clear</a>
                </form>
            </div>
            
            <div class="drop-down-sort-menu">
                <button class="click note__addition__btn" id="toggleButton"> Click to add notes</button>
                <div class="menu" id="menuForm">                 
                 <form action="/add" method="post">
                    <div class="note-section">
                        <label for="note">Type in notes</label>
                        <textarea id="note_block" name="book_note" required></textarea>
                    </div>
                    <div class="book-number-section">
                        <label for="isbn">Type book's ISBN</label>
                        <input type="text" name="ISBN_input" required>
                    </div>
                    <div class="book-rating-section">
                        <select required name="selectedOption">
                            <option value="" disabled selected>Select a rate number</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                        </select>
                    </div>
                    <div class="submit-button">
                        <button type="submit" class="click">Submit</button>
                    </div>
                </form>
                </div>
            </div>
        </div>
        <div class="note__lines"></div>
        
    </nav>

<div class="note-block">
    <% if (locals.averageRating) { %>
    <div class="library-stats">
        <% if (locals.lastUpdated) { %>
    <p class="last-update-text">
        Library last updated on: 
        <strong><%= new Date(lastUpdated).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }) %></strong>
    </p>
    <% } %>
        <div class="stat-card">
        <span class="stat-label">Average Library Score:</span>
        <span class="stat-value"><%= averageRating %> / 10</span>
        </div>
    </div>
    <% } %>
    
    <% if (locals.currentPage && locals.totalPages) { %>
   <div class="pagination">
    <% if (locals.currentPage && locals.currentPage > 1) { %>
        <a href="/?page=<%= currentPage - 1 %>" class="page-btn">« Previous</a>
    <% } %>

    <% if (locals.currentPage && locals.totalPages) { %>
        <span class="page-info">Page <%= currentPage %> of <%= totalPages %></span>
    <% } %>

    <% if (locals.currentPage && locals.totalPages && currentPage < totalPages) { %>
        <a href="/?page=<%= currentPage + 1 %>" class="page-btn">Next »</a>
    <% } %>
    </div>

    <% } %>
    <% if (locals.error) { %>
        <div class="error-banner"><%= error %></div>
    <% } %>

    <% if (locals.searchQuery) { %>
        <div class="search-results-info">
            <p>Showing <%= noteList.length %> results for "<strong><%= searchQuery %></strong>"</p>
        </div>
    <% } %>

    <% if (noteList.length === 0) { %>
        <div class="empty-state">
            <img src="https://cdn-icons-png.flaticon.com/512/3429/3429149.png" alt="Library" width="120">
            <h3>Your library is empty</h3>
            <p>Start by searching for a book ISBN below to add your first note!</p>
        </div>
    <% } else { %>
        <% for (let book of noteList) { %>
            <div class="note-row">
                <div class="img-block">
                    
                    <h1 class="title-book"> <%= book.book_title %> </h1>
                    <h4 class="author-name">by <%= book.author %></h4> <div class="rating-badge"></div>
                    <h3 class="rate-number"> My rating is: <%= book.book_rating %>/10</h3> 
                    <p class="time-stamp"><%= book.date_created %></p>
                   
                   <img class="book-image" src="https://covers.openlibrary.org/b/isbn/<%= book.isbn %>-M.jpg" alt="Book Cover" />
                    <p class="book--note--txt" id="text<%=book.id%>"><%= book.book_notes %></p>
                    
                    <form class="edit-form" action="/edit" method="post">
                        <input type="hidden" name="updatedItemId" value="<%= book.id %>">
                        <textarea id="input<%=book.id%>" name="updatedNotes" hidden><%= book.book_notes %></textarea>
                        <button id="done<%=book.id%>" type="submit" class="save-btn click" hidden>Save</button>
                    </form>
                </div>

                <div class="delete__section">
                    <form action="/delete" method="post">
                        <input type="hidden" name="deleteItemId" value="<%= book.id %>">
                        <label class="checkbox-container">
                            <h3>tick to revel delete button</h3>
                            <input type="checkbox" id="confirm-<%= book.id %>" onchange="toggleDeleteButton('<%= book.id %>')">
                            <span>Confirm delete</span>
                        </label>
                        <button type="submit" id="btn-<%= book.id %>" class="note--delete-btn" disabled>DELETE</button>
                    </form>
                </div>

                <button id="edit<%=book.id%>" class="edit-trigger click" onclick="handler('<%=book.id%>')">Edit Note</button>
            </div>
        <% } %>
    <% } %>
</div>

</section>
<script>
    function autoResize() {
        this.style.height = 'auto';
        this.style.height = this.scrollHeight + 'px';
    }

    document.addEventListener('input', function (event) {
        if (event.target.tagName.toLowerCase() === 'textarea') {
            autoResize.call(event.target);
        }
    }, false);

    function handler(id) {
        const elementsToHide = ["text" + id, "edit" + id];
        const elementsToShow = ["input" + id, "done" + id];

        elementsToHide.forEach(elId => {
            const el = document.getElementById(elId);
            if (el) el.setAttribute("hidden", "true");
        });

        elementsToShow.forEach(elId => {
            const el = document.getElementById(elId);
            if (el) {
                el.removeAttribute("hidden");
                if (elId === "input" + id) {
                    el.focus();
                    autoResize.call(el);
                }
            }
        });
    }

    const toggleBtn = document.getElementById('toggleButton');
    const menuForm = document.getElementById('menuForm');
    if (toggleBtn) {
        toggleBtn.addEventListener('click', function() {
            menuForm.classList.toggle('is-visible');
        });
    }

    function toggleDeleteButton(id) {
        const checkbox = document.getElementById(`confirm-${id}`);
        const button = document.getElementById(`btn-${id}`);
        
        if (checkbox && button) {
            button.disabled = !checkbox.checked;
            if (checkbox.checked) {
                button.classList.add('active');
            } else {
                button.classList.remove('active');
            }
        }
    }
</script>
<%- include('partials/footer.ejs'); -%>